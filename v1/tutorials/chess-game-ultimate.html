

<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><title>Chess game - more features — Kingly.js</title>
  <meta charset="utf-8">
  <meta name="description" content="Kingly - The Modelling Library for Portable UIs">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Chess game - more features — Kingly.js">
  <meta property="og:description" content="Kingly - The Modelling Library for Portable UIs">
  <meta property="og:image" content="https://brucou.github.io/documentation//documentation/images/kingly_logo.png">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Chess game - more features — Kingly.js">
  <meta name="twitter:description" content="Kingly - The Modelling Library for Portable UIs">
  <meta name="twitter:image" content="https://brucou.github.io/documentation/images/kingly_logo.png">

  <link rel="apple-touch-icon" sizes="180x180" href="/documentation/images/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/documentation/images/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="256x256" href="/documentation/images/icons/favicon-256x256.png">
  <link rel="icon" href="/documentation/images/kingly_logo.png" type="image/png">

  <link href="//fonts.googleapis.com/css?family=Lato:300,400,600" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Overlock:400&text=Kingly.js" rel="stylesheet" type="text/css">

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

  <!-- main page styles -->
  <link rel="stylesheet" href="/documentation/css/page.css">

  <!--<script src="/documentation/js/kingly.js"></script>-->

  <!-- ga -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-141924019-1', 'brucou.github.io/documentation');
    ga('send', 'pageview');
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body class="docs">    <div id="mobile-bar">
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><a class="menu-button"></a>
      <a class="logo" href="/documentation"></a>
    </div>
    

<div id="header">
  <a id="logo" href="/documentation/">
    <img src="/documentation/images/kingly_logo.png" alt="library logo">
    <span>Kingly</span>
    
  </a>
  <ul id="nav">
    <li class="nav-dropdown-container learn">
  <a class="nav-link">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tutorials/" class="nav-link current">Tutorials</a></li>
        <li><a href="/documentation/v1/examples/" class="nav-link">Examples</a></li>
        <li><a href="/documentation/v1/cookbook/" class="nav-link">Cookbook</a></li>
        <li><a href="/documentation/v1/best-practices/" class="nav-link">Best practices</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/api/index.html" class="nav-link team">API</a>
</li>
<li class="nav-dropdown-container tooling">
  <a class="nav-link">Tooling</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tooling/graph_editing.html" class="nav-link">Graph editing</a></li>
        <li><a href="/documentation/v1/tooling/compiling.html" class="nav-link">Compiling</a></li>
        <li><a href="/documentation/v1/tooling/devtool.html" class="nav-link">Devtool</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container integrations">
  <a class="nav-link">Integrations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/int-vanilla/" class="nav-link">Vanilla js</a></li>
        <li><a href="/documentation/v1/int-react/" class="nav-link">React</a></li>
        <li><a href="/documentation/v1/int-vue/" class="nav-link">Vue</a></li>
        <li><a href="/documentation/v1/int-svelte/" class="nav-link">Svelte</a></li>
        <li><a href="/documentation/v1/int-others/" class="nav-link">Others</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/testing/index.html" class="nav-link team">Testing</a>
</li>
<li>
  <a href="/documentation/v1/contributed/index.html" class="nav-link team">Contributed</a>
</li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      <li class="nav-dropdown-container learn">
  <a class="nav-link">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tutorials/" class="nav-link current">Tutorials</a></li>
        <li><a href="/documentation/v1/examples/" class="nav-link">Examples</a></li>
        <li><a href="/documentation/v1/cookbook/" class="nav-link">Cookbook</a></li>
        <li><a href="/documentation/v1/best-practices/" class="nav-link">Best practices</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/api/index.html" class="nav-link team">API</a>
</li>
<li class="nav-dropdown-container tooling">
  <a class="nav-link">Tooling</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tooling/graph_editing.html" class="nav-link">Graph editing</a></li>
        <li><a href="/documentation/v1/tooling/compiling.html" class="nav-link">Compiling</a></li>
        <li><a href="/documentation/v1/tooling/devtool.html" class="nav-link">Devtool</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container integrations">
  <a class="nav-link">Integrations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/int-vanilla/" class="nav-link">Vanilla js</a></li>
        <li><a href="/documentation/v1/int-react/" class="nav-link">React</a></li>
        <li><a href="/documentation/v1/int-vue/" class="nav-link">Vue</a></li>
        <li><a href="/documentation/v1/int-svelte/" class="nav-link">Svelte</a></li>
        <li><a href="/documentation/v1/int-others/" class="nav-link">Others</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/testing/index.html" class="nav-link team">Testing</a>
</li>
<li>
  <a href="/documentation/v1/contributed/index.html" class="nav-link team">Contributed</a>
</li>

    </ul>
    <div class="list">
      
        <h2>
          
          Tutorials
          
            <select class="version-select">
              <option value="SELF" selected>1.0</option>
            </select>
          
        </h2>
        <ul class="menu-root">
  
    
    
      
        <li><h3>Introduction</h3></li>
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/index.html" class="sidebar-link">Why Kingly</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/counter-application.html" class="sidebar-link">Counter application</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/installation.html" class="sidebar-link">Installation</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/model-with-machines.html" class="sidebar-link">Implementing UIs with state machines</a>
    </li>
  
    
    
      
      
        <li><h3>Password meter</h3></li>
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter.html" class="sidebar-link">Modelization</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-implementation.html" class="sidebar-link">Machine implementation</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-ui-implementation.html" class="sidebar-link">Interface implementation</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-using-graph-editor.html" class="sidebar-link new">Implementation with the yEd graph editor</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-compiling.html" class="sidebar-link new">Compiling the machine</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-learnt.html" class="sidebar-link">What we learned</a>
    </li>
  
    
    
      
      
      
        <li><h3>Chess game</h3></li>
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/chess-game.html" class="sidebar-link">Two-player chess game</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/chess-game-evolved.html" class="sidebar-link">Chess game - adding features</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/chess-game-ultimate.html" class="sidebar-link current">Chess game - more features</a>
    </li>
  
    
    
      
      
      
      
      
        <li><h3 class="new">RealWorld clone</h3></li>
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world.html" class="sidebar-link">RealWorld app</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-home.html" class="sidebar-link">Home route</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-sign-up.html" class="sidebar-link">Sign-up route</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-sign-in.html" class="sidebar-link">Sign-in route</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-editor.html" class="sidebar-link">Editor route</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-settings.html" class="sidebar-link">Settings route</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-profile.html" class="sidebar-link">User profile route</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-article.html" class="sidebar-link">Article route</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-refactoring.html" class="sidebar-link">Refactoring</a>
    </li>
  
    
    
      
      
      
      
      
    
    
    <li>
      <a href="/documentation/v1/tutorials/real-world-lessons-learnt.html" class="sidebar-link">Lessons learnt</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>



<div class="content tutorials with-sidebar ">
  
    
    
  
  
    <h1>Chess game - more features</h1>
  
  
    <p>In this section, we are going to add some more features to our chess application. In the process, we will introduce other important pieces for modeling behavior with state machines: history pseudo-states and transient states. We will again reflect on the maintainability of state-machine-based interface implementation.</p>
<h2 id="New-features’-specifications"><a href="#New-features’-specifications" class="headerlink" title="New features’ specifications"></a>New features’ specifications</h2><p>We are going to add two new features: a clock timing the game, and a way to pause that clock. The clock will display the elapsed time since the game has started (which will be since the application started). The clock should be updated every second.  </p>
<p>Interface-wise, this means adding a timer area where the clock is displayed. Clicking on the clock should suspend the clock, and clicking a second time on the clock should resume it. Ideally, the clock should blink if and only if paused.</p>
<p>We have the following screens corresponding to different states of the application:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Initial screen</th>
<th style="text-align:left">2s later</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><img src="../../images/chess%20game/initial%20screen%20with%20clock.jpg" alt="initial screen with clock"></td>
<td style="text-align:left"><img src="../../images/chess%20game/initial%20screen%20with%20clock%202s.jpg" alt="initial screen"></td>
</tr>
</tbody>
</table>
</div>
<h2 id="Modification-targets"><a href="#Modification-targets" class="headerlink" title="Modification targets"></a>Modification targets</h2><p>As before, we will examine each of our three modules composing the application for modification purposes.</p>
<h3 id="The-machine"><a href="#The-machine" class="headerlink" title="The machine"></a>The machine</h3><p>As we have seen, the machine simply translates events into commands. We have two new events here: a new elapsed second (<code>SECOND_ELAPSED</code>), and a click on the clock (<code>CLOCK_CLICKED</code>).</p>
<p>The <code>SECOND_ELAPSED</code> event should trigger the update of the clock. After that, any other events should be processed by the machine as before the <code>SECOND_ELAPSED</code> event. That means that, whatever control state the machine was in, it must trigger the specified commands and then return to that control state to resume its standard behavior. We have 5 atomic control states. We could, for each of those states, add a transition to the origin control state (unsurprisingly called <em>self-transition</em> or <em>auto-transition</em>). This is however not very maintainable. If later, we have a 6th control state, we have to remember to also add a transition for that new control state. In short, we have an invisible, undocumented logical dependency. </p>
<p>The click on the clock area should toggle pausing/resuming of the clock. If the game is not paused, then a  <code>CLOCK_CLICKED</code> event should trigger the pausing of the clock. Any events coming in the machine while the game is paused should not trigger any action! When the game is resumed (<code>CLOCK_CLICKED</code> event received while the game is paused), the game should resume where it was. That means that whatever control state the game was in, it should return to that control state. Just like before, we could duplicate for each of the 5 control states, the transitions which implement this behavior. </p>
<label for="mn-demo-5" class="margin-toggle">⊕</label><input type="checkbox" id="mn-demo-5" class="margin-toggle"><span class="marginnote"><p>Think about why they may amount to 15 in the worse case as an exercise.</p>
</span>
<p>If we would do the duplication for those two new features, we would end up with up to 15 new transitions! That is more than what we have already, and that would render the graph difficult to read. In the previous chapter, we showed how transitions from and to compound states were <strong>factoring</strong> a group of transitions between atomic control states into a single one involving the compound state. We are now going to introduce another such group factoring, with a different logic: <strong>history pseudo-state</strong>.  </p>
<p>History pseudo-states are <strong>target</strong> control states, <strong>associated with a compound state</strong>. A transition targetting such a pseudo-control state is interpreted at run-time by the machine as a transition to the last control state the associated compound state was in, after the machine left that compound state. This is best explained with an example. The modelization of the two requested features is as follows:</p>
<label for="mn-demo-13" class="margin-toggle">⊕</label><input type="checkbox" id="mn-demo-13" class="margin-toggle"><span class="marginnote"><p>Do you understand why this machine implements the aforedescribed behavior? You can imagine a user story which includes pausing the clock, map it to an event sequence, and run the machine in your head with those events. Do it! It is a good habit to manually check a machine vs. the expected behavior.</p>
</span>
<p><img src="../../graphs/chess%20game%20with%20hierarchy%20with%20undo%20and%20timer%20highlighted%20with%20init.jpg" alt="chess game with clock"></p>
<p>Our potentially 15 new transitions have been reduced to 4! The history pseudo-state is represented in the previous graph as a small circle with the label <strong>H*</strong>. It is called a pseudo-state because it is not an actual control state. It is a joker which is replaced at run-time, when the transition is taken, by an existing control state. Consider the following run of the machine:</p>
<label for="mn-demo-20" class="margin-toggle">⊕</label><input type="checkbox" id="mn-demo-20" class="margin-toggle"><span class="marginnote"><p>Here the hyphen — does not mean null or an empty value but a default value. More details can be found in the <a href="../api">API section</a></p>
</span>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Control state</th>
<th style="text-align:left">H*(Game on.)</th>
<th style="text-align:left">Event</th>
<th style="text-align:left">New control state</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>White plays</strong></td>
<td style="text-align:left">—</td>
<td style="text-align:left">White piece clicked</td>
<td style="text-align:left"><strong>White piece selected</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>White piece selected</strong></td>
<td style="text-align:left">—</td>
<td style="text-align:left">Game paused</td>
<td style="text-align:left"><strong>Pausing</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Pausing</strong></td>
<td style="text-align:left"><strong>White piece selected</strong></td>
<td style="text-align:left">White piece clicked</td>
<td style="text-align:left"><strong>Pausing</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>Pausing</strong></td>
<td style="text-align:left"><strong>White piece selected</strong></td>
<td style="text-align:left">Game resumed</td>
<td style="text-align:left"><strong>White piece selected</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>White piece selected</strong></td>
<td style="text-align:left"><strong>White piece selected</strong></td>
<td style="text-align:left">White piece clicked</td>
<td style="text-align:left"><strong>White piece selected</strong></td>
</tr>
<tr>
<td style="text-align:left"><strong>White piece selected</strong></td>
<td style="text-align:left"><strong>White piece selected</strong></td>
<td style="text-align:left">Empty square clicked, legal non-winning move</td>
<td style="text-align:left"><strong>Black plays</strong></td>
</tr>
</tbody>
</table>
</div>
<p>The history pseudo-state for the <em>Game on</em> compound state is evaluated and has a non-default value when and only when the machine has exited the <em>Game on</em> compound state. That value is precisely the atomic control state the machine was in, just before exiting the compound state.</p>
<p>The history mechanism helps us represent economically behaviors such as interrupts (switch one behavior for another one temporarily) or co-routines (cooperate sequentially with another behavior to produce a combined behavior). </p>
<p>That is all there is to know for now about history pseudo-states. Let’s continue to use the previous modelization of our two new features and introduce a new type of control state termed <strong>transient state</strong>. Per the graph visualization, on receiving a <code>TICK</code> event, the machine will transition to the <em>Updating clock</em> control state… and <strong>immediately</strong> move on to the next control state, as defined by the possible guards specified for that control state. Here the transition is to the history pseudo-state. By immediately, we mean that the machine will <strong>synchronously</strong> transition to the next control state without, or before processing or receiving any other events on the way. Transient states are for that reason also called <strong>eventless states</strong>.</p>
<label for="mn-demo-26" class="margin-toggle">⊕</label><input type="checkbox" id="mn-demo-26" class="margin-toggle"><span class="marginnote"><p>By orthogonal, we mean that the added pieces of state machine do not rely on, and do not modify any piece of extended state used in other parts of the machine.</p>
</span>
<p>Do you remember how in the previous tutorial we added <em>props</em> to our rendering React component, and that led us to have to reexamine all rendering commands of the state machine to pass the updated <em>props</em> list? We would very much like instead to add the features and modifying the minimal amount of code possible. We achieve this here, by replacing the default render handler of our <code>&lt;Machine&gt;</code> React component with our <a href="#API-dive">own customized handler</a>.</p>
<p>Our custom render handler now expects the <strong>changed</strong> props rather than the full set of <em>props</em> necessary to handle the component. Where we might have had in the <code>updateAndDisplayClock</code> action factory:</p>
<pre><code class="hljs js">&#123;
  <span class="hljs-attr">command</span>: COMMAND_RENDER,
  <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">gameDuration</span>: gameDuration + <span class="hljs-number">1</span>, draggable, width, position, boardStyle, squareStyles, onSquareClick, turn, status &#125;
&#125;</code></pre>
<p>we instead have:</p>
<pre><code class="hljs js">&#123;
  <span class="hljs-attr">command</span>: COMMAND_RENDER,
  <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">gameDuration</span>: gameDuration + <span class="hljs-number">1</span> &#125;
&#125;</code></pre>
<p>We have finished analyzing the impact of the new features on the machine. Because we have only added to the existing behavior features that are orthogonal to it, we do not have to modify any piece of state used by the existing state machine. This is a best case when it comes to maintainability.</p>
<h3 id="Interfaced-systems"><a href="#Interfaced-systems" class="headerlink" title="Interfaced systems"></a>Interfaced systems</h3><p>The interfaced systems are two: the chess engine, and the output device (screen). We do not touch the chess engine here. We do have to update our rendering component:</p>
<pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ClockArea</span>(<span class="hljs-params">props</span>) </span>&#123;
  <span class="hljs-keyword">const</span> &#123; next, gameDuration, isPaused &#125; = props;
  <span class="hljs-keyword">const</span> spanClass = isPaused ? <span class="hljs-string">".blinking"</span> : <span class="hljs-string">".still.clock"</span>;
  <span class="hljs-keyword">return</span> span(
    spanClass,  
    &#123; <span class="hljs-attr">onClick</span>: <span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> &#123; next(&#123; <span class="hljs-attr">CLOCK_CLICKED</span>: <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> &#125;)&#125; &#125;, 
    format(gameDuration)
  )
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ChessBoardWithInfo</span>(<span class="hljs-params">props</span>) </span>&#123;
  <span class="hljs-keyword">const</span> &#123; (...), gameDuration , isPaused &#125; = props;
  (...)
  <span class="hljs-keyword">const</span> clockAreaProps = &#123; next, gameDuration, isPaused &#125;;

  <span class="hljs-keyword">return</span> div(<span class="hljs-string">".game"</span>, [
    div(<span class="hljs-string">".game-board"</span>, [
      h(Chessboard, chessBoardProps)
    ]),
    div(<span class="hljs-string">".info"</span>, [
      div(<span class="hljs-string">".action"</span>, [
        h(InfoArea, infoAreaProps),
        h(ActionArea, actionAreaProps)
      ]),
      h(ClockArea, clockAreaProps)
    ])
  ])
&#125;</code></pre>
<h3 id="Command-handlers"><a href="#Command-handlers" class="headerlink" title="Command handlers"></a>Command handlers</h3><p>We have to new commands: <code>SET_TIMER</code> and <code>CANCEL_TIMER</code>, which respectively schedule a tick, and cancel a scheduled tick:</p>
<label for="mn-demo-29" class="margin-toggle">⊕</label><input type="checkbox" id="mn-demo-29" class="margin-toggle"><span class="marginnote"><p>Note how the <code>setTimer</code> and <code>cancelTimer</code> share a piece of state <code>timerId</code>. We could have put the <code>timerId</code> as a piece of state of the machine and pass that in the <code>SET_TIMER</code> and <code>CANCEL_TIMER</code> commands. We opted not to do so. This keeps the machine simpler. As an exercise, you can try to implement what we discarded here, to understand why our choice makes sense.  </p>
</span>
<pre><code class="hljs js"><span class="hljs-keyword">const</span> timerFactory = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> &#123;
  <span class="hljs-keyword">let</span> timerId = <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">return</span> &#123;
    <span class="hljs-attr">setTimer</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTimer</span>(<span class="hljs-params">next, delay, effectHandlers</span>) </span>&#123;
      <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">setTimer</span>: sT &#125; = effectHandlers;
      timerId = sT(<span class="hljs-number">1000</span>, _ =&gt; next(&#123; <span class="hljs-attr">TICK</span>: <span class="hljs-keyword">void</span> <span class="hljs-number">0</span> &#125;));
    &#125;,
    <span class="hljs-attr">cancelTimer</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cancelTimer</span>(<span class="hljs-params">next, delay, effectHandlers</span>) </span>&#123;
      <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">cancelTimer</span>: cT &#125; = effectHandlers;
      cT(timerId);
    &#125;,
  &#125;
&#125;
<span class="hljs-keyword">const</span> &#123;setTimer, cancelTimer&#125; = timerFactory();</code></pre>
<h3 id="API-dive"><a href="#API-dive" class="headerlink" title="API dive"></a>API dive</h3><p>The transitions for the updated machine is as follows:</p>
<pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; ACTION_IDENTITY, DEEP, historyState, INIT_EVENT &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">"kingly"</span>
(...)

<span class="hljs-keyword">const</span> transitions = [
  &#123; <span class="hljs-attr">from</span>: OFF, <span class="hljs-attr">event</span>: START, <span class="hljs-attr">to</span>: GAME_ON, <span class="hljs-attr">action</span>: ACTION_IDENTITY &#125;,
  &#123; <span class="hljs-attr">from</span>: GAME_ON, <span class="hljs-attr">event</span>: INIT_EVENT, <span class="hljs-attr">to</span>: WHITE_TURN, <span class="hljs-attr">action</span>: resetAndStartTimer &#125;,
  &#123; <span class="hljs-attr">from</span>: WHITE_TURN, <span class="hljs-attr">event</span>: INIT_EVENT, <span class="hljs-attr">to</span>: WHITE_PLAYS, <span class="hljs-attr">action</span>: displayInitScreen &#125;,
  &#123; <span class="hljs-attr">from</span>: GAME_ON, <span class="hljs-attr">event</span>: TICK, <span class="hljs-attr">to</span>: UPDATING_CLOCK, <span class="hljs-attr">action</span>: updateAndDisplayClock &#125;,
  &#123; <span class="hljs-attr">from</span>: UPDATING_CLOCK, <span class="hljs-attr">event</span>: <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>, <span class="hljs-attr">to</span>: historyState(DEEP, GAME_ON), <span class="hljs-attr">action</span>: ACTION_IDENTITY &#125;,
  &#123; <span class="hljs-attr">from</span>: GAME_ON, <span class="hljs-attr">event</span>: CLOCK_CLICKED, <span class="hljs-attr">to</span>: PAUSED_CLOCK, <span class="hljs-attr">action</span>: pauseClock &#125;,
  &#123; <span class="hljs-attr">from</span>: PAUSED_CLOCK, <span class="hljs-attr">event</span>: CLOCK_CLICKED, <span class="hljs-attr">to</span>: historyState(DEEP, GAME_ON), <span class="hljs-attr">action</span>: resumeClock &#125;,
  (...)
];</code></pre>
<p>Note how <code>historyState</code>, exported by the Kingly library is used to encode a history pseudo-state. We introduced in this tutorial only one of the two history types, the most frequently used, called the deep history. We will not detail the second history type supported by Kingly until the need to do so emerge. It suffices to say that <code>historyState(DEEP, GAME_ON)</code> is the (deep) history pseudo-state associated with the control state <code>GAME_ON</code>.</p>
<p>We have achieved a more maintainable machine by specifying minimal render commands. In the context of React UI implementation, this is achieved by using a custom renderer. The <code>Machine</code> component from <code>react-state-driven</code> allows customizing the rendering of the application by setting a rendering function as the <code>COMMAND_RENDER</code> property of the <code>effectHandlers</code> <em>prop</em> of the <code>&lt;Machine&gt;</code> component. For instance, in this tutorial example:</p>
 <label for="mn-demo-31" class="margin-toggle">⊕</label><input type="checkbox" id="mn-demo-31" class="margin-toggle"><span class="marginnote"><p>This is similar to React’s <code>this.setState(obj)</code> which merges the current state with <code>obj</code>. We here merge the current <em>props</em> with the new ones.</p>
</span>
 <pre><code class="hljs js">effectHandlers: &#123;
  [COMMAND_RENDER]: <span class="hljs-function">(<span class="hljs-params">machineComponent, renderWith, params, next</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">const</span> newProps = merge(machineComponent.state.props, params);
    machineComponent.setState(
      &#123;
        <span class="hljs-attr">render</span>: h(renderWith, <span class="hljs-built_in">Object</span>.assign(&#123;&#125;, newProps, &#123; next &#125;), []),
        <span class="hljs-attr">props</span>: newProps
      &#125;,
    );
  &#125;,
  (...)
&#125;,</code></pre>
<p>The custom render handler is passed four parameters, the first of which being the React component which handles the application display concern. That component has a <code>render</code> property which is the React element to render. The handler is also passed the <code>renderWith</code> React component, passed by the user as <em>prop</em> of the <code>&lt;Machine&gt;</code> component. The <code>params</code> parameter corresponds to the <code>params</code> property of the render command. Finally <code>next</code> is an event emitter proxying events to the state machine.    </p>
<h2 id="Altogether-now"><a href="#Altogether-now" class="headerlink" title="Altogether now"></a>Altogether now</h2><p>The final implementation can be accessed here:</p>
<!-- Copy and Paste Me -->
<div class="glitch-embed-wrap" style="height: 500px; width: 1000px;">
  <iframe src="https://glitch.com/embed/#!/embed/chess-game-ultimate?path=src/fsm.js&sidebarCollapsed=true&attributionHidden=true&previewSize=40" alt="chess-game-basics on Glitch" style="height: 100%; width: 100%; border: 0;">
  </iframe>
</div>

<h2 id="What-we-learned"><a href="#What-we-learned" class="headerlink" title="What we learned"></a>What we learned</h2><p>In this tutorial, we learned two new types of control states: history pseudo-state and transient state. A history pseudo-state is linked to a compound state, and maps, at transition time, to an atomic state of that compound state. That atomic state is the last atomic state the compound state was in before the machine exited the compound state. Transient states are states with zero duration: the machine enters the transient state and exits it synchronously and immediately.</p>
<p>History pseudo-states are useful to implement interrupts or co-routines, passing the control flow temporary to another part of the machine. Transient states are useful to intercalate transitions/actions between sections of a state machine. Transient states and history control states, when used in conjunction with compound states may reduce significantly the complexity of the graph modeling the interface behavior.</p>
<p>We showed that better maintainability can be achieved as a result of design principles — passing the minimum of information necessary for a command to achieve its task, and separating the extended state into orthogonal parts. </p>
<p>We shown that Kingly’s clean architecture enables reuse. The dependency graph for our implementation is as follows (in orange are the parts of the implementation which we had to write):</p>
<p>We were able to write a two-player chess game in very little code, quickly and with good confidence that our UI will do what it is supposed to do! The key productivity factor here has been <strong>reuse</strong>. Reuse is a key benefit of  clean architecture. In the following dependency graph, we outlined in orange the parts which we had to write. We reused all the rest with the net result that our chess UI needs to know very little about the chess game:</p>
<figure class="fullwidth"><p><img src="../../graphs/chess%20game%20dependency%20in%20reality%20chart.png" alt="dependency graph chess game"></p>
</figure>
<p>The dependency graph also shows that the state machine for the chess UI does not depend on React, hence we can reuse it with any UI rendering library. <code>ChessBoardWithInfo</code> being a pure component, it does not depend on the interfaced systems as is often the case with React components (for instance when fetching data at mount time). We can reuse it anywhere in any React application.</p>
<p>Lastly, we saw that Kingly and <code>react-state-driven</code> can be customized (<a href="http://blog.symprise.net/2009/06/23/open-closed-principle-concerns-about-change-in-software-design/" target="_blank" rel="noopener">open/closed principle</a>). For instance, Kingly allows developers to inject dependencies in a machine, which facilitates testing. <code>react-state-driven</code> proposes a default renderer which can be amply customized.</p>
<h2 id="Exercises"><a href="#Exercises" class="headerlink" title="Exercises"></a>Exercises</h2><p>To check your understanding, you can try to add the following feature:</p>
<ul>
<li>display pieces that have been captured. <strong>HINT</strong>: The <code>ChessBoard</code> component has a dedicated property for that. The display feature should be toggled on and off by the players. By default captured pieces should not be displayed </li>
</ul>

  
  
    <div class="next-links">
      
      
        <span>← <a href="/documentation/v1/tutorials/chess-game-evolved.html">Chess game - adding features</a></span>
      
      
      
        <span style="float: right;"><a href="/documentation/v1/tutorials/real-world.html">RealWorld app</a> →</span>
      
    </div>
  
  <div class="footer">
    <a id="follow-button" class="btn" title="Kingly Github" href="https://github.com/brucou/kingly">
      <img class="github" src="/documentation/images/GitHub-Mark-32px.png" alt="github">
    </a>
    <a id="follow-button" class="btn" title="Follow Kingly on Twitter" href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fbrucou.github.io/documentation%2F&amp;ref_src=twsrc%5Etfw&amp;region=follow_link&amp;screen_name=bricoi1&amp;tw_p=followbutton">
      <img class="twitter" src="/documentation/images/icons8-twitter-48.png" alt="twitter">
    </a>
  </div>
</div>

      </div>
      <script src="/documentation/js/smooth-scroll.min.js"></script>
    

    <!-- script for sidebars, version selects etc. -->
    <script src="/documentation/js/css.escape.js"></script>
    <script src="/documentation/js/common.js"></script>
    <!-- mathjax-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>
