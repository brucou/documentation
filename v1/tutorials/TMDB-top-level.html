

<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><title>Top level breakdown — Kingly.js</title>
  <meta charset="utf-8">
  <meta name="description" content="Kingly - The Modelling Library for Portable UIs">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Top level breakdown — Kingly.js">
  <meta property="og:description" content="Kingly - The Modelling Library for Portable UIs">
  <meta property="og:image" content="https://brucou.github.io/documentation//documentation/images/kingly_logo.png">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Top level breakdown — Kingly.js">
  <meta name="twitter:description" content="Kingly - The Modelling Library for Portable UIs">
  <meta name="twitter:image" content="https://brucou.github.io/documentation/images/kingly_logo.png">

  <link rel="apple-touch-icon" sizes="180x180" href="/documentation/images/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/documentation/images/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="256x256" href="/documentation/images/icons/favicon-256x256.png">
  <link rel="icon" href="/documentation/images/kingly_logo.png" type="image/png">

  <link href="//fonts.googleapis.com/css?family=Lato:300,400,600" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Overlock:400&text=Kingly.js" rel="stylesheet" type="text/css">

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

  <!-- main page styles -->
  <link rel="stylesheet" href="/documentation/css/page.css">

  <!--<script src="/documentation/js/kingly.js"></script>-->

  <!-- ga -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-141924019-1', 'brucou.github.io/documentation');
    ga('send', 'pageview');
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body class="docs">    <div id="mobile-bar">
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><a class="menu-button"></a>
      <a class="logo" href="/documentation"></a>
    </div>
    

<div id="header">
  <a id="logo" href="/documentation/">
    <img src="/documentation/images/kingly_logo.png" alt="library logo">
    <span>Kingly</span>
    
  </a>
  <ul id="nav">
    <li class="nav-dropdown-container learn">
  <a class="nav-link">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tutorials/" class="nav-link current">Tutorials</a></li>
        <li><a href="/documentation/v1/examples/" class="nav-link">Examples</a></li>
        <li><a href="/documentation/v1/cookbook/" class="nav-link">Cookbook</a></li>
        <li><a href="/documentation/v1/best-practices/" class="nav-link">Best practices</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/api/index.html" class="nav-link team">API</a>
</li>
<li class="nav-dropdown-container integrations">
  <a class="nav-link">Integrations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/int-vanilla/" class="nav-link current">Vanilla js</a></li>
        <li><a href="/documentation/v1/int-react/" class="nav-link">React</a></li>
        <li><a href="/documentation/v1/int-vue/" class="nav-link">Vue</a></li>
        <li><a href="/documentation/v1/int-svelte/" class="nav-link">Svelte</a></li>
        <li><a href="/documentation/v1/int-others/" class="nav-link">Others</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/testing/index.html" class="nav-link team">Testing</a>
</li>
<li>
  <a href="/documentation/v1/contributed/index.html" class="nav-link team">Contributed</a>
</li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      <li class="nav-dropdown-container learn">
  <a class="nav-link">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tutorials/" class="nav-link current">Tutorials</a></li>
        <li><a href="/documentation/v1/examples/" class="nav-link">Examples</a></li>
        <li><a href="/documentation/v1/cookbook/" class="nav-link">Cookbook</a></li>
        <li><a href="/documentation/v1/best-practices/" class="nav-link">Best practices</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/api/index.html" class="nav-link team">API</a>
</li>
<li class="nav-dropdown-container integrations">
  <a class="nav-link">Integrations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/int-vanilla/" class="nav-link current">Vanilla js</a></li>
        <li><a href="/documentation/v1/int-react/" class="nav-link">React</a></li>
        <li><a href="/documentation/v1/int-vue/" class="nav-link">Vue</a></li>
        <li><a href="/documentation/v1/int-svelte/" class="nav-link">Svelte</a></li>
        <li><a href="/documentation/v1/int-others/" class="nav-link">Others</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/testing/index.html" class="nav-link team">Testing</a>
</li>
<li>
  <a href="/documentation/v1/contributed/index.html" class="nav-link team">Contributed</a>
</li>

    </ul>
    <div class="list">
      
        <h2>
          
          Tutorials
          
            <select class="version-select">
              <option value="SELF" selected>1.0</option>
            </select>
          
        </h2>
        <ul class="menu-root">
  
    
    
      
        <li><h3>Introduction</h3></li>
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/index.html" class="sidebar-link">Why Kingly</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/counter-application.html" class="sidebar-link">Counter application</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/installation.html" class="sidebar-link">Installation</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/model-with-machines.html" class="sidebar-link">Implementing UIs with state machines</a>
    </li>
  
    
    
      
      
        <li><h3>Password meter</h3></li>
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter.html" class="sidebar-link">Modelization</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-implementation.html" class="sidebar-link">Machine implementation</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-ui-implementation.html" class="sidebar-link">Interface implementation</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/password-meter-learnt.html" class="sidebar-link">What we learnt</a>
    </li>
  
    
    
      
      
      
        <li><h3>Chess game</h3></li>
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/chess-game.html" class="sidebar-link">Two-player chess game</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/chess-game-evolved.html" class="sidebar-link">Chess game - adding features</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/chess-game-ultimate.html" class="sidebar-link">Chess game - more features</a>
    </li>
  
    
    
      
      
      
      
        <li><h3>Movie database interface</h3></li>
      
    
    <li>
      <a href="/documentation/v1/tutorials/tmdb-online-interface.html" class="sidebar-link">Specifications</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/TMDB-top-level.html" class="sidebar-link current">Top level breakdown</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/tmdb-routing.html" class="sidebar-link">Routing</a>
    </li>
  
    
    
      
      
      
      
    
    <li>
      <a href="/documentation/v1/tutorials/TMDB-movie-query.html" class="sidebar-link">Movie querying</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>



<div class="content tutorials with-sidebar ">
  
    
    
  
  
    <h1>Top level breakdown</h1>
  
  
    <p>The key to reaching a modelization of a behaviour with state machines is to remember that said behaviour is the relation between incoming events and the commands to perform on the interfaced systems. Equivalently, it is a pure function between a sequence of incoming events and the corresponding sequence of commands to perform on the interfaced systems. You are going to read that as many times as necessary all over the tutorials because it is just that important.</p>
<p>Let’s consider our TMDB online interface with this in mind. In the relation, we have first the events, and then the actions. Those two we know. Then we have to express the functional mapping between the two. </p>
<p>Let’s start with events. What events do we have incoming to our interface? </p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>ROUTE_CHANGED</code></td>
<td style="text-align:left">the first event to consider is the one that leads to the user to the online interface in the first place. In our case, that is a routing event: the url changes to whatever route that means the online interface should be operative.</td>
</tr>
<tr>
<td style="text-align:left"><code>SEARCH_RESULTS_RECEIVED</code></td>
<td style="text-align:left">The TMDB database querying may succeed</td>
</tr>
<tr>
<td style="text-align:left"><code>SEARCH_ERROR_RECEIVED</code></td>
<td style="text-align:left">The TMDB database querying may fail</td>
</tr>
<tr>
<td style="text-align:left"><code>QUERY_CHANGED</code></td>
<td style="text-align:left">The user may change the movie to query TMDB against by updating the input field</td>
</tr>
<tr>
<td style="text-align:left"><code>MOVIE_SELECTED</code></td>
<td style="text-align:left">The user may select a displayed movie</td>
</tr>
<tr>
<td style="text-align:left"><code>MOVIE_DETAILS_DESELECTED</code></td>
<td style="text-align:left">The user may click to remove the view of the selected movie’s details</td>
</tr>
<tr>
<td style="text-align:left"><code>SEARCH_RESULTS_MOVIE_RECEIVED</code></td>
<td style="text-align:left">The TMDB database movie detail querying may succeed</td>
</tr>
<tr>
<td style="text-align:left"><code>SEARCH_ERROR_MOVIE_RECEIVED</code></td>
<td style="text-align:left">The TMDB database movie detail querying may fail</td>
</tr>
</tbody>
</table>
</div>
<p>What actions do we have?</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>COMMAND_RENDER</code></td>
<td style="text-align:left">We have to display screens</td>
</tr>
<tr>
<td style="text-align:left"><code>COMMAND_MOVIE_SEARCH</code></td>
<td style="text-align:left">We need to query the TMDB database for movies</td>
</tr>
<tr>
<td style="text-align:left"><code>COMMAND_MOVIE_DETAILS_SEARCH</code></td>
<td style="text-align:left">We need to query the TMDB database for movie details</td>
</tr>
</tbody>
</table>
</div>
<p>Now let’s see how we can express the relationship between events and commands. Remember that we want to arrive to a procedure <code>fsm</code> such <code>commands = fsm(event)</code>, with <code>fsm</code> having encapsulated state. </p>
<p>To start with, our specifications dictate that routing to the appropriate url should trigger the display of the user interface. In the absence of that event, it does not matter which other events are sent to the machine, there will be no commands to execute (indicated in Kingly by <code>NO_OUTPUT</code>). In other words, using pseudo code, <code>fsm</code> is such that:</p>
<pre><code class="hljs haskell"><span class="hljs-title">fsm</span> :: <span class="hljs-type">Event</span> -&gt; <span class="hljs-type">Commands</span>
| <span class="hljs-keyword">if</span> there was a past routing event with the <span class="hljs-type">TMDB</span> slug     (&lt;- state reflecting past events)
|    fsmA
| <span class="hljs-keyword">else</span> 
|    fsmB

<span class="hljs-title">fsmB</span> :: <span class="hljs-type">Event</span> -&gt; <span class="hljs-type">Commands</span>
| <span class="hljs-keyword">if</span> event is routing event and has <span class="hljs-type">TMDB</span> slug <span class="hljs-keyword">then</span>
|   there was a past routing event with the <span class="hljs-type">TMDB</span> slug &lt;- true
|   fsmA
| <span class="hljs-keyword">else</span> 
|   event =&gt; <span class="hljs-type">NO_OUTPUT</span>

<span class="hljs-title">fsmA</span> :: <span class="hljs-type">Event</span> -&gt; <span class="hljs-type">Commands</span>
| (how to precisely deal with the rest <span class="hljs-keyword">of</span> events we'll figure out later)</code></pre>
<p>Looking at the <code>fsm</code> pseudo code, we associate <code>fsm</code> to two entirely different computations depending on a condition. In short, the condition affects the <strong>control flow</strong> of the computation of commands. The piece of state which we have identified we will thus call a <strong>control state</strong>. So we have two control states now. The one the machine starts in (call that <code>init</code> for now), and then the one corresponding to <em>there was a routing event in the past with the TMDB slug</em> (call that <code>TMDB app</code>).</p>
<p>With this we can write the equivalent JavaScript code as follows:</p>
<pre><code class="hljs javascript"><span class="hljs-comment">// Starting with there was a past routing event with the TMDB slug &lt;- false</span>
<span class="hljs-keyword">let</span> controlState = INIT;  

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fsm</span>(<span class="hljs-params">event</span>)</span>&#123;
  <span class="hljs-keyword">if</span> (controlState !== INIT) &#123;
    <span class="hljs-keyword">return</span> fsmA(event)
  &#125;
  <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">return</span> fsmB(event)
  &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fsmB</span>(<span class="hljs-params">event</span>) </span>&#123;
  <span class="hljs-keyword">if</span> (isRoutingEvent(event) &amp;&amp; isTMDBSlub(event)) &#123;
    controlState = TMDB_APP;

    <span class="hljs-keyword">return</span> fsmA(event)
  &#125;
  <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">return</span> NO_OUTPUT
  &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fsmA</span>(<span class="hljs-params">event</span>) </span>&#123;
  <span class="hljs-comment">// Don't know yet exactly how to write it</span>
  <span class="hljs-comment">// but we know the mapping, that's our specs</span>
  ...
  return...    
&#125;</code></pre>
<p>And that gives us the following modelization, if you add to the picture all the events handled by the machine, and the corresponding actions:</p>
<label for="mn-demo-5" class="margin-toggle">⊕</label><input type="checkbox" id="mn-demo-5" class="margin-toggle"><span class="marginnote"></span>
<p><img src="../../graphs/movie-search/TMDB%20start.png" alt="top level state machine"></p>
<p>You will recognize <code>fsmB</code> as ruling over the computation of commands in the control state <em>init</em>, and <code>fsmA</code> as the ruler when the machine is in the control state <em>TMDB app</em>. As a reminder of our visual formalism, the following arrow of the state machine graph:</p>
<pre><code class="hljs text">QUERY_CHANGED [shouldProcess]
/ ??</code></pre>
<p>expresses the fact that, in some conditions (determined by the <code>shouldProcess</code> predicate), when the value of the input field changes, e.g. when the user types in, the application must execute some commands, which we have not determined yet, hence the interrogation marks <code>??</code>. The guard <code>shouldProcess</code> prevents a <code>QUERY_CHANGED</code> event from being processed when it should not. That is the case for instance when the interface displays a movie detail view in which the content of the query input field <strong>cannot</strong> be changed because it is not accessible. In other words, the guard protects us against processing semantically invalid or unexpected events. This helps <strong>robustness</strong>, which is defined as the ability of a computer system to cope with errors during execution and cope with <strong>erroneous inputs</strong>. </p>
<p>Note that we have completely explicited <code>fsmB</code> but only partially explicited <code>fsmA</code>. We have not explicited at all the <code>shouldProcess</code> functions, and the commands to compute as a result of events processed by <code>fsmA</code>.<br>However, we obtained a partial implementation which already fulfills a small part of our specification:</p>
<ul>
<li>running <code>fsm</code> with a routing event whose embedded url is not a TMDB url should result in <code>NO_OUTPUT</code></li>
</ul>
<p>If you look at <code>fsmA</code>, you will observe that it has the same shape as <code>fsm</code>: it is a function which takes events and returns commands. This means we can apply the same process we did for <code>fsm</code> to fulfill a larger part of our specifications, till we eventually fulfill the whole specification set. This is the essence of the top-down method. We break down a computation into computations with a smaller scope, and then we go figure out how to implement the smaller computations. The process by which we progressively detail the implementation of a <code>fsmX</code> function is called <strong>refinement</strong>. </p>
<p>With that established, let’s refine.</p>

  
  
    <div class="next-links">
      
      
        <span>← <a href="/documentation/v1/tutorials/tmdb-online-interface.html">Specifications</a></span>
      
      
      
        <span style="float: right;"><a href="/documentation/v1/tutorials/tmdb-routing.html">Routing</a> →</span>
      
    </div>
  
  <div class="footer">
    <a id="follow-button" class="btn" title="Kingly Github" href="https://github.com/brucou/kingly">
      <img class="github" src="/documentation/images/GitHub-Mark-32px.png" alt="github">
    </a>
    <a id="follow-button" class="btn" title="Follow Kingly on Twitter" href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fbrucou.github.io/documentation%2F&amp;ref_src=twsrc%5Etfw&amp;region=follow_link&amp;screen_name=bricoi1&amp;tw_p=followbutton">
      <img class="twitter" src="/documentation/images/icons8-twitter-48.png" alt="twitter">
    </a>
  </div>
</div>

      </div>
      <script src="/documentation/js/smooth-scroll.min.js"></script>
    

    <!-- script for sidebars, version selects etc. -->
    <script src="/documentation/js/css.escape.js"></script>
    <script src="/documentation/js/common.js"></script>
    <!-- mathjax-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
