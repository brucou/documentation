

<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><title>Compiler — Kingly.js</title>
  <meta charset="utf-8">
  <meta name="description" content="Kingly - The Modelling Library for Portable UIs">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Compiler — Kingly.js">
  <meta property="og:description" content="Kingly - The Modelling Library for Portable UIs">
  <meta property="og:image" content="https://brucou.github.io/documentation//documentation/images/kingly_logo.png">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Compiler — Kingly.js">
  <meta name="twitter:description" content="Kingly - The Modelling Library for Portable UIs">
  <meta name="twitter:image" content="https://brucou.github.io/documentation/images/kingly_logo.png">

  <link rel="apple-touch-icon" sizes="180x180" href="/documentation/images/icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/documentation/images/icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="256x256" href="/documentation/images/icons/favicon-256x256.png">
  <link rel="icon" href="/documentation/images/kingly_logo.png" type="image/png">

  <link href="//fonts.googleapis.com/css?family=Lato:300,400,600" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=Overlock:400&text=Kingly.js" rel="stylesheet" type="text/css">

  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

  <!-- main page styles -->
  <link rel="stylesheet" href="/documentation/css/page.css">

  <!--<script src="/documentation/js/kingly.js"></script>-->

  <!-- ga -->
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-141924019-1', 'brucou.github.io/documentation');
    ga('send', 'pageview');
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body class="docs">    <div id="mobile-bar">
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><a class="menu-button"></a>
      <a class="logo" href="/documentation"></a>
    </div>
    

<div id="header">
  <a id="logo" href="/documentation/">
    <img src="/documentation/images/kingly_logo.png" alt="library logo">
    <span>Kingly</span>
    
  </a>
  <ul id="nav">
    <li class="nav-dropdown-container learn">
  <a class="nav-link">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tutorials/" class="nav-link">Tutorials</a></li>
        <li><a href="/documentation/v1/examples/" class="nav-link">Examples</a></li>
        <li><a href="/documentation/v1/cookbook/" class="nav-link">Cookbook</a></li>
        <li><a href="/documentation/v1/best-practices/" class="nav-link">Best practices</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/api/index.html" class="nav-link team">API</a>
</li>
<li class="nav-dropdown-container tooling">
  <a class="nav-link current">Tooling</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tooling/graph_editing.html" class="nav-link">Graph editing</a></li>
        <li><a href="/documentation/v1/tooling/compiling.html" class="nav-link current">Compiling</a></li>
        <li><a href="/documentation/v1/tooling/devtool.html" class="nav-link">Devtool</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container integrations">
  <a class="nav-link">Integrations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/int-vanilla/" class="nav-link">Vanilla js</a></li>
        <li><a href="/documentation/v1/int-react/" class="nav-link">React</a></li>
        <li><a href="/documentation/v1/int-vue/" class="nav-link">Vue</a></li>
        <li><a href="/documentation/v1/int-svelte/" class="nav-link">Svelte</a></li>
        <li><a href="/documentation/v1/int-others/" class="nav-link">Others</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/testing/index.html" class="nav-link team">Testing</a>
</li>
<li>
  <a href="/documentation/v1/contributed/index.html" class="nav-link team">Contributed</a>
</li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
          
  <div class="sidebar">
  <div class="sidebar-inner">
    <ul class="main-menu">
      <li class="nav-dropdown-container learn">
  <a class="nav-link">Learn</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tutorials/" class="nav-link">Tutorials</a></li>
        <li><a href="/documentation/v1/examples/" class="nav-link">Examples</a></li>
        <li><a href="/documentation/v1/cookbook/" class="nav-link">Cookbook</a></li>
        <li><a href="/documentation/v1/best-practices/" class="nav-link">Best practices</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/api/index.html" class="nav-link team">API</a>
</li>
<li class="nav-dropdown-container tooling">
  <a class="nav-link current">Tooling</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/tooling/graph_editing.html" class="nav-link">Graph editing</a></li>
        <li><a href="/documentation/v1/tooling/compiling.html" class="nav-link current">Compiling</a></li>
        <li><a href="/documentation/v1/tooling/devtool.html" class="nav-link">Devtool</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container integrations">
  <a class="nav-link">Integrations</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/documentation/v1/int-vanilla/" class="nav-link">Vanilla js</a></li>
        <li><a href="/documentation/v1/int-react/" class="nav-link">React</a></li>
        <li><a href="/documentation/v1/int-vue/" class="nav-link">Vue</a></li>
        <li><a href="/documentation/v1/int-svelte/" class="nav-link">Svelte</a></li>
        <li><a href="/documentation/v1/int-others/" class="nav-link">Others</a></li>
      </ul>
    </li>
  </ul>
</li>

<li>
  <a href="/documentation/v1/testing/index.html" class="nav-link team">Testing</a>
</li>
<li>
  <a href="/documentation/v1/contributed/index.html" class="nav-link team">Contributed</a>
</li>

    </ul>
    <div class="list">
      
        <h2>
          
          
          
            <select class="version-select">
              <option value="SELF" selected>1.0</option>
            </select>
          
        </h2>
        <ul class="menu-root">
  
    
    
    
      
      
      
    
    <li>
      <a href="/documentation/v1/tooling/graph_editing.html" class="sidebar-link new">Graph editors</a>
    </li>
  
    
    
    
      
      
      
    
    <li>
      <a href="/documentation/v1/tooling/compiling.html" class="sidebar-link current new">Compiler</a>
    </li>
  
    
    
    
      
      
    
    <li>
      <a href="/documentation/v1/tooling/devtool.html" class="sidebar-link new">Dev tool</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>



<div class="content tooling with-sidebar ">
  
    
    
  
  
    <h1>Compiler</h1>
  
  
    <h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>The <code>slim</code> package aims at supporting the creation of state machines with the <a href="https://brucou.github.io/documentation/">Kingly state machine library</a>. The Kingly state machine library may hover around a bundle size of 10-15KB. While Kingly is tree-shakeable and in practice the size after tree-shaking is around 5KB, the <code>slim</code> compiler allows developers to reduce the footprint of their state machines. This may be worthy if developers are using only a few small machines. We expect that, as the machine grows in complexity (number of control states, and hierarchy depth), the gain in bundle size obtained through the compiler is naturally reduced. We, however, estimate the effort worthwhile, as developers would likely have to write really large machines to come down to the same size than the library (which includes debugging, tracing, and error management).</p>
<p>With the <a href="https://www.yworks.com/products/yed-live" target="_blank" rel="noopener">yed graph editor</a>, <a href="https://github.com/brucou/yed2Kingly" target="_blank" rel="noopener">devtool</a>, and the present compiler, we believe the minimal set of pieces is in place for developing and maintaining comfortably large Kingly state machines.</p>
<h2 id="Guiding-principles"><a href="#Guiding-principles" class="headerlink" title="Guiding principles"></a>Guiding principles</h2><ul>
<li>the generated code should be readable by a human</li>
<li>the generated code should work in as many browsers as possible with a minimum of polyfills</li>
<li>the generated code should be easy to debug</li>
</ul>
<p>We thus decided to use <code>prettier</code>, include comments in the generated code, and avoid arrow functions and other newer JavaScript language features.</p>
<h2 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work?"></a>How does it work?</h2><p>In a typical process, I start designing a machine from the specifications by drawing it in the yEd editor. When I am done or ready to test the results of my design, I save the file. yEd by default saves its files in a <code>.graphml</code> format. I save the graphml file in the same directory in which I want to use the created state machine. From there, a previously launched watcher runs the <code>slim</code> node script on the newly saved file and generates the compiled JavaScript file which exports the machine factory — you can of course also run the script manually instead of using a watcher. The provided exports can then be used as parameters to create a Kingly state machine.</p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><p><code>npm install slim</code></p>
<h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><pre><code class="hljs bash">slim file.graphml</code></pre>
<p>Running the converter produces two files, targeted at consumption in a browser and node.js environment:</p>
<p>Before:<br><pre><code class="hljs bash">src/graphs/file.graphml</code></pre></p>
<p>After:<br><pre><code class="hljs bash">src/graphs/file.graphml.fsm.compiled.js
src/graphs/file.graphml.fsm.compiled.cjs</code></pre></p>
<p>The converter must emit an error or exit with an error code if the converted graph will not give rise to a valid Kingly machine (in particular cf. rules). The idea is to fail as early as possible.</p>
<p>The produced file export one factory function which when runs with the right parameters will return a Kingly state machine.</p>
<p>There are plenty of examples of use in the test directory. Let’s illustrate the parameters received by the factory function:</p>
<pre><code class="hljs js"><span class="hljs-comment">// require the js file</span>
<span class="hljs-keyword">const</span> &#123; createStateMachine &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;graphMlFile&#125;</span>.fsm.compiled.cjs`</span>);

<span class="hljs-comment">// Build the machine</span>
<span class="hljs-keyword">const</span> guards = &#123;
  <span class="hljs-string">'not(isNumber)'</span>: <span class="hljs-function">(<span class="hljs-params">s, e, stg</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> s.n !== <span class="hljs-string">'number'</span>,
  <span class="hljs-attr">isNumber</span>: <span class="hljs-function">(<span class="hljs-params">s, e, stg</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> s.n === <span class="hljs-string">'number'</span>,
&#125;;
<span class="hljs-keyword">const</span> actionFactories = &#123;
  <span class="hljs-attr">logOther</span>: <span class="hljs-function">(<span class="hljs-params">s, e, stg</span>) =&gt;</span> (&#123; <span class="hljs-attr">outputs</span>: [<span class="hljs-string">`logOther run on <span class="hljs-subst">$&#123;s.n&#125;</span>`</span>], <span class="hljs-attr">updates</span>: &#123;&#125; &#125;),
  <span class="hljs-attr">logNumber</span>: <span class="hljs-function">(<span class="hljs-params">s, e, stg</span>) =&gt;</span> (&#123; <span class="hljs-attr">outputs</span>: [<span class="hljs-string">`logNumber run on <span class="hljs-subst">$&#123;s.n&#125;</span>`</span>], <span class="hljs-attr">updates</span>: &#123;&#125; &#125;),
&#125;;
<span class="hljs-keyword">const</span> fsm1 = createStateMachine(&#123;
  <span class="hljs-attr">initialExtendedState</span>: &#123; <span class="hljs-attr">n</span>: <span class="hljs-number">0</span> &#125;,
  actionFactories,
  guards,
  updateState,
&#125;, settings);</code></pre>
<p>As can be seen from the example, the factory function’s first parameter consists of four objects: the initial extended state of the machine; the JavaScript code for the action factories and guards referenced by name in the <code>.graphml</code> file;  and a reducer function <code>updateState</code> which takes an object and an array of modifications to perform on that object.</p>
<p>Note that the compiled machine does not offer error messages, protection against malformed inputs, devtool or logging functionality. This is only possible when using the Kingly library.</p>
<p>Note also that, as much as possible, we refrain from using advanced JavaScript language features in the code generated by the compiler with a view for that code to be usable in older browsers without polyfilling or babel-parsing. This, however, has not really been tested so far.</p>
<h2 id="Rules"><a href="#Rules" class="headerlink" title="Rules"></a>Rules</h2><h4 id="Some-definitions"><a href="#Some-definitions" class="headerlink" title="Some definitions:"></a>Some definitions:</h4><ul>
<li>An initial transition is that which originates from a node whose label is <code>init</code> or any capitalized variations (such as <code>Init</code>, <code>INit</code>, <code>iniT</code>, etc.)</li>
<li>A top-level initial transition is that initial transition which does not have any parent node  </li>
<li>A history pseudo-state is a node whose label is <code>H</code> (shallow history) or <code>H*</code> (deep history) with this same capitalization  </li>
<li>A compound node is a node which is created in the yEd interface by using the group functionality (<em>Grouping &gt; Group</em> or <em>Ctrl-Alt-G</em> in version 3.19).  </li>
</ul>
<h4 id="slim-rules"><a href="#slim-rules" class="headerlink" title="slim rules:"></a><code>slim</code> rules:</h4><ul>
<li>The compiler converts the <code>.graphml</code> file using the same algorithm than <code>yed2Kingly</code>. As such the same conversion rules that apply: the machine encoded in the <code>.graphml</code> file must correspond to a valid Kingly machine.</li>
<li>no control state, i.e. no node in the yEd graph can have an <code>init</code>-like label if that control state is not an initial transition.</li>
<li>the previous rule applies also for control states which are not pseudo-control states. They cannot be labelled a <code>H</code> or <code>H*</code>. Be careful that <code>h</code> will not be considered to be a pseudo control state, but a regular control state.</li>
<li>edge labels (which contain the event/guard/action triple under the following syntax <code>event [guard] / action (comment)</code>) are parsed with an <a href="https://github.com/brucou/slim/blob/master/yedEdgeLabelGrammar.ne" target="_blank" rel="noopener">EBNF grammar</a>. As of July 2020, to avoid having to handle an ambiguous grammar:<ul>
<li><code>event</code> cannot have the characters <code>[</code>, <code>]</code>, <code>/</code>, <code>,</code> and <code>|</code> </li>
<li><code>guard</code> cannot have the characters <code>[</code>, <code>]</code>, and <code>,</code></li>
<li><code>actions</code> cannot have the characters <code>[</code>, <code>]</code>, <code>/</code>, <code>,</code> <code>(</code>, <code>)</code>, and <code>|</code></li>
</ul>
</li>
<li>edge labels can encode multiple transitions, provided those transitions encoding are separated by the <code>|</code> (pipe) character:<ul>
<li>e.g. <code>| event1 [guard1] / action1 | event2 [guard2] / action2</code> encodes two transitions triggered respectively by <code>event1</code> and <code>event2</code></li>
</ul>
</li>
<li>edge labels also encode composite guards and composite actions. Composite guards and actions are comma-separated actions. <code>guard1, guard2</code> encodes a guard which will be satisfied only and only if both <code>guard1</code> and <code>guard2</code> are satisfied. Similarly, <code>action1, action2</code> encode two actions that will be composed to form a single action. The outputs of the composed is the concatenation of the outputs of each action, in the same order<ul>
<li>e.g. <code>event [cond1, cond2] / action1, action2 (comment)</code></li>
</ul>
</li>
</ul>
<p>The rules have been chosen for expressiveness, readability and multi-language support. Events, guards and actions can thus be described with several words if that is more descriptive. Unicode characters are accepted, meaning all languages supported by Unicode are supported by the compiler too. The few existing restrictions are for disambiguity: we do not want the compiler user to not write erroneous labels inadvertently.</p>
<h4 id="EBNF-grammar"><a href="#EBNF-grammar" class="headerlink" title="EBNF grammar"></a>EBNF grammar</h4><pre><code class="hljs ebnf">MAIN -&gt; OneTransitionLabel | MultipleTransitionLabel
MultipleTransitionLabel -&gt; ("|" OneTransitionLabel):+
OneTransitionLabel -&gt;
  EventClause "[" GuardClause "]" _ "/" ActionsClause  
| EventClause "[" GuardClause "]" _                    
| EventClause "/" ActionsClause                        
| EventClause                                          
| "[" GuardClause "]" _ "/" ActionsClause              
| "/" ActionsClause                                    
| "[" GuardClause "]"                                  

EventClause -&gt; [^\/\[\]\|,]:+
GuardClause -&gt; Guard ("," Guard):*                     
Guard -&gt; [^\[\],]:*
ActionsClause -&gt; Action ("," Action):*                 
Action        -&gt; [^\/\|\[\]\(\),]:* ActionsComments:*
ActionsComments -&gt; "(" __ ")" _
StringLiteral -&gt; [\w]:+
  _ -&gt; [\s]:*
  __ -&gt; [^()]:*</code></pre>
<h2 id="Size-of-file-generated"><a href="#Size-of-file-generated" class="headerlink" title="Size of file generated"></a>Size of file generated</h2><p>There are plenty of graph examples in the <a href="https://github.com/brucou/slim/tree/master/tests/graphs" target="_blank" rel="noopener">test directory</a>. </p>
<p>Assuming the machine has no isolated states (i.e. states which are not reached by any transitions), the size of the compiled file follows the shape <code>a + b x Number of transitions</code>, i.e. is mostly proportional to the number of transitions of the graph. The proportional coefficient <code>b</code> seems to be fairly low and the compression factor increases with the size of the machine. In short, you need to write a really large graph to get to 5Kb just for the machine.</p>
<p>We give two data points. For the sake of these measurements, minification is performed online with the <a href="https://javascript-minifier.com/" target="_blank" rel="noopener">javascript-minifier</a> tool. Liens of code are counted with an <a href="https://codetabs.com/count-loc/count-loc-online.html" target="_blank" rel="noopener">online tool</a>. The simple counter machine, which is about the smallest non-trivial machine that can be drawn:</p>
<p><img src="https://imgur.com/mk9hM6u.png" alt="counter machine graph"></p>
<p>is compiled (as of Slim 0.6.0) to 37 lines of code, and has a minified compressed size of 500 bytes.</p>
<p>The password meter machine, a slightly more complex but still small example from the <a href="https://brucou.github.io/documentation/v1/tutorials/password-meter.html">documentation website</a>:   </p>
<p><img src="https://brucou.github.io/documentation/graphs/password-meter.png" alt="[password meter modelization]"></p>
<p>is compiled (as of Slim 0.6.0) to zero-dependency 75 lines of code:</p>
<pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createStateMachine</span>(<span class="hljs-params">fsmDefForCompile, stg</span>) </span>&#123;
  <span class="hljs-keyword">var</span> actions = fsmDefForCompile.actionFactories;
  <span class="hljs-keyword">var</span> guards = fsmDefForCompile.guards;
  <span class="hljs-keyword">var</span> updateState = fsmDefForCompile.updateState;
  <span class="hljs-keyword">var</span> initialExtendedState = fsmDefForCompile.initialExtendedState;

  <span class="hljs-comment">// Initialize machine state,</span>
  <span class="hljs-keyword">var</span> cs = <span class="hljs-string">"nok"</span>;
  <span class="hljs-keyword">var</span> es = initialExtendedState;

  <span class="hljs-keyword">var</span> eventHandlers = &#123;
    n4ღidle: &#123;
      <span class="hljs-attr">start</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">es, ed, stg</span>) </span>&#123;
        <span class="hljs-keyword">let</span> computed = actions[<span class="hljs-string">"display initial screen"</span>](es, ed, stg);
        cs = <span class="hljs-string">"n3ღweak"</span>;
        es = updateState(es, computed.updates);

        <span class="hljs-keyword">return</span> computed;
      &#125;,
    &#125;,
    n3ღweak: &#123;
      <span class="hljs-attr">typed</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">es, ed, stg</span>) </span>&#123;
        <span class="hljs-keyword">let</span> computed = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (guards[<span class="hljs-string">"!letter and numbers?"</span>](es, ed, stg)) &#123;
          computed = actions[<span class="hljs-string">"display weak password screen"</span>](es, ed, stg);
          cs = <span class="hljs-string">"n3ღweak"</span>;
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (guards[<span class="hljs-string">"letter and numbers?"</span>](es, ed, stg)) &#123;
          computed = actions[<span class="hljs-string">"display strong password screen"</span>](es, ed, stg);
          cs = <span class="hljs-string">"n2ღstrong"</span>;
        &#125;
        <span class="hljs-keyword">if</span> (computed !== <span class="hljs-literal">null</span>) &#123;
          es = updateState(es, computed.updates);
        &#125;

        <span class="hljs-keyword">return</span> computed;
      &#125;,
    &#125;,
    n2ღstrong: &#123;
      <span class="hljs-attr">typed</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">es, ed, stg</span>) </span>&#123;
        <span class="hljs-keyword">let</span> computed = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (guards[<span class="hljs-string">"letter and numbers?"</span>](es, ed, stg)) &#123;
          computed = actions[<span class="hljs-string">"display strong password screen"</span>](es, ed, stg);
          cs = <span class="hljs-string">"n2ღstrong"</span>;
        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (guards[<span class="hljs-string">"!letter and numbers?"</span>](es, ed, stg)) &#123;
          computed = actions[<span class="hljs-string">"display weak password screen"</span>](es, ed, stg);
          cs = <span class="hljs-string">"n3ღweak"</span>;
        &#125;
        <span class="hljs-keyword">if</span> (computed !== <span class="hljs-literal">null</span>) &#123;
          es = updateState(es, computed.updates);
        &#125;

        <span class="hljs-keyword">return</span> computed;
      &#125;,
      <span class="hljs-string">"clicked submit"</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">es, ed, stg</span>) </span>&#123;
        <span class="hljs-keyword">let</span> computed = actions[<span class="hljs-string">"display password submitted screen"</span>](es, ed, stg);
        cs = <span class="hljs-string">"n1ღdone"</span>;
        es = updateState(es, computed.updates);

        <span class="hljs-keyword">return</span> computed;
      &#125;,
    &#125;,
    <span class="hljs-attr">nok</span>: &#123;
      <span class="hljs-attr">init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">es, ed, stg</span>) </span>&#123;
        cs = <span class="hljs-string">"n4ღidle"</span>; <span class="hljs-comment">// No action, only cs changes!</span>

        <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">outputs</span>: [], <span class="hljs-attr">updates</span>: [] &#125;;
      &#125;,
    &#125;,
  &#125;;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params">event</span>) </span>&#123;
    <span class="hljs-keyword">var</span> eventLabel = <span class="hljs-built_in">Object</span>.keys(event)[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">var</span> eventData = event[eventLabel];
    <span class="hljs-keyword">var</span> controlStateHandlingEvent = (eventHandlers[cs] || &#123;&#125;)[eventLabel] &amp;&amp; cs;

    <span class="hljs-keyword">if</span> (controlStateHandlingEvent) &#123;
      <span class="hljs-comment">// Run the handler</span>
      <span class="hljs-keyword">var</span> computed = eventHandlers[controlStateHandlingEvent][eventLabel](es, eventData, stg);

      <span class="hljs-comment">// cs, es, hs have been updated in place by the handler</span>
      <span class="hljs-comment">// If transition, but no guards fulfilled =&gt; null, else =&gt; computed outputs</span>
      <span class="hljs-keyword">return</span> computed === <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : computed.outputs;
    &#125;
    <span class="hljs-comment">// Event is not accepted by the machine</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  &#125;

  <span class="hljs-comment">// Start the machine</span>
  process(&#123; [<span class="hljs-string">"init"</span>]: initialExtendedState &#125;);

  <span class="hljs-keyword">return</span> process;
&#125;

<span class="hljs-keyword">export</span> &#123; createStateMachine &#125;;</code></pre>
<p>with a minified compressed size of 660 bytes. </p>
<p>The following complex wizard form:</p>
<figure class="fullwidth"><p><img src="https://imgur.com/xcO9xnY.jpg" alt="Imgur"></p>
</figure>
<p>was <a href="https://github.com/brucou/cycle-state-machine-demo" target="_blank" rel="noopener">implemented</a> with a machine having around 25 transitions: </p>
<p><img src="https://github.com/brucou/cycle-state-machine-demo/raw/master/public/assets/images/graphs/sparks%20application%20process%20with%20comeback%20proper%20syntax%20-%20flat%20fsm.png" alt="subscription wizard form modelization"></p>
<p>The first implementation of the <a href="https://rw-kingly-svelte.bricoi1.now.sh/#/" target="_blank" rel="noopener">Conduit average-sized application</a> has ~50 states, ~100 transitions and weighted 3.3KB min.gzipped. We estimated that writing this logic by hand may have shaved 200 (extra code due to compiler) + 300 bytes (extra code due to using a graph editor), which is thus the cost we pay for using state machines and the graph editor (0.5KB). To give a useful comparison, the smallest state machine library clocks at 1KB, and that’s before having defined the machine itself.</p>
<p>Those preliminary results are fairly consistent. Assuming 30 bytes per transitions (computed from the previous data points), with a base line of 500 bytes, to reach 5KB we need a machine with 150 transitions!! Note that this size does not (and cannot) include the actions and guards but does represent the size of the logic encoded in the machine.</p>
<p>In summary, endowed with the present compiler, <strong>Kingly proposes state machines as a zero-cost abstraction</strong>. This means that if you would have written that logic by hand, you would not have been able to achieve a significantly improved min.gzipped size.</p>
<h2 id="Known-limitations"><a href="#Known-limitations" class="headerlink" title="Known limitations"></a>Known limitations</h2><p>The <code>.graphml</code> format for yEd is not publicly documented. The parser for it thus may have holes or may break if the format specifications change, It is thus important that you log issues if you encounter any errors wile running the compiler. To be fair, the specifications have not changed in many years.</p>
<h2 id="Final-note"><a href="#Final-note" class="headerlink" title="Final note"></a>Final note</h2><p>After using and working with state machines for the past four years, I believe I am reaching a satisfying API and process. The idea is really to avoid unnecessary complexity. I am however interested in hearing your comments, and suggestions together with use cases that you believe are not satisfactorily addressed -&gt; post an issue in the project directory.</p>
<ul>
<li>explain the new syntax for composites guards and actions and edge cases (no () except at the end for actions)<ul>
<li>NO: [isAuthenticated &amp; tags already fetched] / update (reset) pagination fetch articles render loading</li>
<li>no commas in action names or guards names (basically review the grammar maybe paste it)</li>
</ul>
</li>
</ul>

  
  
  <div class="footer">
    <a id="follow-button" class="btn" title="Kingly Github" href="https://github.com/brucou/kingly">
      <img class="github" src="/documentation/images/GitHub-Mark-32px.png" alt="github">
    </a>
    <a id="follow-button" class="btn" title="Follow Kingly on Twitter" href="https://twitter.com/intent/follow?original_referer=https%3A%2F%2Fbrucou.github.io/documentation%2F&amp;ref_src=twsrc%5Etfw&amp;region=follow_link&amp;screen_name=bricoi1&amp;tw_p=followbutton">
      <img class="twitter" src="/documentation/images/icons8-twitter-48.png" alt="twitter">
    </a>
  </div>
</div>

      </div>
      <script src="/documentation/js/smooth-scroll.min.js"></script>
    

    <!-- script for sidebars, version selects etc. -->
    <script src="/documentation/js/css.escape.js"></script>
    <script src="/documentation/js/common.js"></script>
    <!-- mathjax-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


</body>
</html>
